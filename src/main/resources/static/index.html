<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Live Broadcast</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; margin: 0; display: flex; justify-content: center; background-color: #f0f2f5; height: 100vh; }
        .container { width: 400px; background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin-top: 50px; height: 600px; display: flex; flex-direction: column; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }

        /* ë¡œë¹„ í™”ë©´ */
        #lobby-view { display: flex; flex-direction: column; height: 100%; }
        #create-broadcast-btn { padding: 15px; background-color: #ff5722; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        #create-broadcast-btn:hover { background-color: #e64a19; }
        #broadcast-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .broadcast-item { padding: 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .broadcast-item:hover { border-color: #2196F3; background-color: #e3f2fd; }
        .broadcast-badge { background-color: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; }

        /* ì±„íŒ… í™”ë©´ */
        #chat-view { display: none; flex-direction: column; height: 100%; }
        #chat-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        #back-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; }
        #chat-messages { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: #fafafa; border-radius: 4px; margin-bottom: 10px; }

        .message { margin-bottom: 8px; padding: 6px 10px; border-radius: 8px; max-width: 80%; word-wrap: break-word; font-size: 0.9em; }
        .message.join, .message.leave { text-align: center; width: 100%; max-width: 100%; background: none; color: #666; font-size: 0.8em; }
        .message.my-msg { align-self: flex-end; background-color: #dcf8c6; margin-left: auto; }
        .message.other-msg { align-self: flex-start; background-color: white; border: 1px solid #ddd; }

        /* ë‹‰ë„¤ì„ ì…ë ¥ */
        #login-area { text-align: center; margin-top: auto; margin-bottom: auto; }
        #nickname-input { padding: 10px; width: 70%; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        #join-btn { padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;}

        /* ë©”ì‹œì§€ ì „ì†¡ */
        #input-area { display: none; gap: 5px; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #send-button { padding: 10px 15px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">

    <div id="lobby-view">
        <h2>ğŸ”´ ë¼ì´ë¸Œ ë¡œë¹„</h2>
        <button id="create-broadcast-btn">+ ë°©ì†¡ ì‹œì‘í•˜ê¸° (ë°© ë§Œë“¤ê¸°)</button>
        <div id="broadcast-list">
            <div id="empty-msg" style="text-align: center; color: #999; margin-top: 50px;">ì§„í–‰ ì¤‘ì¸ ë°©ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="chat-view">
        <div id="chat-header">
            <button id="back-btn">â¬… ë‚˜ê°€ê¸°</button>
            <span id="room-title-display" style="font-weight: bold; font-size: 1.1em;"></span>
            <span style="width: 24px;"></span>
        </div>
        <div id="chat-messages"></div>

        <div id="login-area">
            <p>ëŒ€í™”ì— ì°¸ì—¬í•˜ë ¤ë©´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„" />
            <br/>
            <button id="join-btn">ì°¸ì—¬í•˜ê¸°</button>
        </div>

        <div id="input-area">
            <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
            <button id="send-button">ì „ì†¡</button>
        </div>
    </div>

</div>

<script>
    var stompClient = null;
    var currentRoomId = null;
    var username = null;
    var isConnected = false;

    // DOM Elements
    const lobbyView = document.getElementById('lobby-view');
    const chatView = document.getElementById('chat-view');
    const broadcastList = document.getElementById('broadcast-list');
    const emptyMsg = document.getElementById('empty-msg');
    const chatMessages = document.getElementById('chat-messages');

    // =========================================================
    // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ: ë³µêµ¬ ë¡œì§ (ìƒˆë¡œê³ ì¹¨ ëŒ€ì‘)
    // =========================================================
    window.onload = function() {
        // A. ë°©ì†¡ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í•­ìƒ ì‹¤í–‰)
        fetch('/rooms').then(res => res.json()).then(rooms => {
            rooms.forEach(roomName => addRoomButton(roomName));
        });
        connectSocket(); // ë¡œë¹„ìš© ì†Œì¼“ ì—°ê²°

        // B. [í•µì‹¬] ì €ì¥ëœ ìƒíƒœ í™•ì¸ í›„ í™”ë©´ ë³µêµ¬
        var savedRoom = sessionStorage.getItem('chat_roomid');
        var savedName = sessionStorage.getItem('chat_username');

        if (savedRoom) {
            // 1. ì €ì¥ëœ ë°©ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì±„íŒ… í™”ë©´ìœ¼ë¡œ ì „í™˜
            enterRoomPage(savedRoom);

            if (savedName) {
                // 2. ì´ë¦„ë„ ìˆìœ¼ë©´ ì…ë ¥ì¹¸ ì±„ìš°ê³  ìë™ ì…ì¥
                document.getElementById('nickname-input').value = savedName;
                joinChat(savedName);
            }
        }
    };

    function connectSocket() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function() {
            isConnected = true;
            stompClient.subscribe('/topic/public', onMessageReceived);
        }, function(err) {
            setTimeout(connectSocket, 5000);
        });
    }

    // =========================================================
    // 2. ë¡œë¹„ ê¸°ëŠ¥
    // =========================================================
    document.getElementById('create-broadcast-btn').addEventListener('click', function() {
        var roomName = prompt("ìƒˆë¡œìš´ ë°©ì†¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (roomName && roomName.trim() !== "") {
            if (isConnected) {
                stompClient.send("/app/chat.create", {}, JSON.stringify({
                    type: 'CREATE',
                    roomId: roomName.trim()
                }));
            } else {
                alert("ì„œë²„ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...");
            }
        }
    });

    function addRoomButton(roomName) {
        if (emptyMsg) emptyMsg.style.display = 'none';

        var exists = Array.from(document.querySelectorAll('.broadcast-item span'))
            .some(span => span.innerText.includes(roomName));
        if(exists) return;

        var item = document.createElement('div');
        item.className = 'broadcast-item';
        item.innerHTML = `<span>ğŸ“º ${roomName}</span> <span class="broadcast-badge">LIVE</span>`;
        item.onclick = function() { enterRoomPage(roomName); };
        broadcastList.appendChild(item);
    }

    // =========================================================
    // 3. ì±„íŒ…ë°© ì…ì¥/í‡´ì¥ (ì„¸ì…˜ ì €ì¥ ì¶”ê°€ë¨)
    // =========================================================
    function enterRoomPage(roomId) {
        currentRoomId = roomId;
        // [ì¤‘ìš”] ë°© ì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ëŒ€ë¹„)
        sessionStorage.setItem('chat_roomid', roomId);

        document.getElementById('room-title-display').innerText = roomId;

        lobbyView.style.display = 'none';
        chatView.style.display = 'flex';

        chatMessages.innerHTML = '';
        document.getElementById('login-area').style.display = 'block';
        document.getElementById('input-area').style.display = 'none';
    }

    document.getElementById('back-btn').addEventListener('click', function() {
        // ë‚˜ê°€ê¸° ì‹œ ì„¸ì…˜ ì •ë³´ ì‚­ì œ
        currentRoomId = null;
        sessionStorage.removeItem('chat_roomid');
        // ë‹‰ë„¤ì„ì€ ë‚¨ê²¨ë‘˜ì§€ ì‚­ì œí• ì§€ ì„ íƒ (ì—¬ê¸°ì„  ë‚¨ê²¨ë‘ )

        lobbyView.style.display = 'flex';
        chatView.style.display = 'none';
    });

    // 'ì°¸ì—¬í•˜ê¸°' ë²„íŠ¼ í´ë¦­
    document.getElementById('join-btn').addEventListener('click', function() {
        var name = document.getElementById('nickname-input').value.trim();
        if(!name) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        joinChat(name);
    });

    // ì‹¤ì œ ì±„íŒ… ì°¸ì—¬ ë¡œì§ (ë¶„ë¦¬í•¨)
    function joinChat(name) {
        username = name;
        sessionStorage.setItem('chat_username', username);

        document.getElementById('login-area').style.display = 'none';
        document.getElementById('input-area').style.display = 'flex';

        fetchHistory(currentRoomId);

        // ì†Œì¼“ì´ ì—°ê²°ëœ ìƒíƒœë¼ë©´ ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
        // (ìƒˆë¡œê³ ì¹¨ ì§í›„ë¼ ì†Œì¼“ ì—°ê²° ì¤‘ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²´í¬)
        if (stompClient && stompClient.connected) {
            sendJoinMessage();
        } else {
            // ì†Œì¼“ ì—°ê²°ì„ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë³´ëƒ„
            var checkInterval = setInterval(function() {
                if (stompClient && stompClient.connected) {
                    sendJoinMessage();
                    clearInterval(checkInterval);
                }
            }, 500);
        }
    }

    function sendJoinMessage() {
        stompClient.send("/app/chat.addUser", {}, JSON.stringify({
            sender: username, type: 'JOIN', roomId: currentRoomId
        }));
    }

    // =========================================================
    // 4. ë©”ì‹œì§€ ì²˜ë¦¬
    // =========================================================
    function onMessageReceived(payload) {
        var message = JSON.parse(payload.body);

        if (message.type === 'CREATE') {
            addRoomButton(message.roomId);
        }
        else if (message.roomId === currentRoomId) {
            displayChatMessage(message);
        }
    }

    function displayChatMessage(message) {
        var el = document.createElement('div');
        el.className = 'message';

        if (message.type === 'JOIN') {
            el.classList.add('join');
            el.innerText = `ğŸ‘‹ ${message.sender} ë‹˜ì´ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤.`;
        } else if (message.type === 'LEAVE') {
            el.classList.add('leave');
            el.innerText = `ğŸ’¨ ${message.sender} ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`;
        } else {
            var isMe = (message.sender === username);
            el.classList.add(isMe ? 'my-msg' : 'other-msg');
            el.innerHTML = `<b>${isMe ? '' : message.sender}</b> ${message.content}`;
        }
        chatMessages.appendChild(el);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function fetchHistory(room) {
        fetch('/history/' + room).then(r=>r.json()).then(msgs => {
            msgs.forEach(displayChatMessage);
        });
    }

    function sendMessage() {
        var input = document.getElementById('message-input');
        var content = input.value.trim();
        if(content && stompClient) {
            var msg = { sender: username, content: content, type: 'CHAT', roomId: currentRoomId };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(msg));
            input.value = '';
        }
    }
    document.getElementById('send-button').onclick = sendMessage;
    document.getElementById('message-input').onkeypress = (e) => { if(e.key==='Enter') sendMessage(); };

</script>
</body>
</html>