<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Live Commerce Chatting</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }

        /* 로비(방 목록) 스타일 */
        #lobby { display: block; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 10px 20px; background-color: #ff4757; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background-color: #e84118; }
        #roomList { list-style: none; padding: 0; }
        #roomList li { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

        /* 채팅방 스타일 */
        #chatRoom { display: none; }
        #messageArea { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; background: #fafafa; border-radius: 8px; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; line-height: 1.4; }
        .my-msg { background-color: #ff4757; color: white; margin-left: auto; text-align: right; }
        .other-msg { background-color: #e1e1e1; color: #333; }
        .system-msg { text-align: center; color: #888; font-size: 0.9em; margin: 10px 0; background: none; max-width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div id="lobby">
        <h2>라이브 방송 목록</h2>
        <div class="input-group">
            <input type="text" id="roomName" placeholder="새로운 방송 제목 입력">
            <button onclick="createRoom()">방송 시작</button>
        </div>
        <ul id="roomList">
        </ul>
    </div>

    <div id="chatRoom">
        <h2 id="roomTitle">채팅방</h2>
        <div id="messageArea"></div>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode==13) sendMessage()">
            <button onclick="sendMessage()">전송</button>
            <button onclick="leaveRoom()" style="background-color: #7f8c8d;">나가기</button>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentBroadcastId = null;
    let nickname = "유저_" + Math.floor(Math.random() * 1000); // 테스트용 닉네임 랜덤 생성

    // 1. 페이지 로드 시 방 목록 가져오기
    document.addEventListener("DOMContentLoaded", fetchRooms);

    function fetchRooms() {
        fetch('/api/chat/rooms')
            .then(res => res.json())
            .then(data => {
                const roomList = document.getElementById('roomList');
                roomList.innerHTML = '';
                data.forEach(id => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>방송 ID: <strong>${id}</strong></span>
                                    <button onclick="enterRoom(${id})">입장하기</button>`;
                    roomList.appendChild(li);
                });
            })
            .catch(err => console.error("방 목록 로딩 실패:", err));
    }

    // 2. 방송(방) 생성
    function createRoom() {
        const name = document.getElementById('roomName').value;
        if(!name) return alert("방송 제목을 입력하세요.");

        fetch('/api/chat/room', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        })
            .then(res => res.json())
            .then(broadcastId => {
                alert("방송이 성공적으로 생성되었습니다! ID: " + broadcastId);
                document.getElementById('roomName').value = '';
                fetchRooms(); // 목록 갱신
            });
    }

    // 3. 채팅방 입장 및 웹소켓 연결
    function enterRoom(broadcastId) {
        currentBroadcastId = broadcastId;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('chatRoom').style.display = 'block';
        document.getElementById('roomTitle').innerText = `방송 #${broadcastId} 실시간 채팅`;
        document.getElementById('messageArea').innerHTML = '';

        // 서버의 /ws 엔드포인트로 연결 (SockJS 사용)
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // [구독] 해당 방송 번호의 메시지 채널 구독
            stompClient.subscribe('/sub/chat/' + broadcastId, function (response) {
                showChatMessage(JSON.parse(response.body));
            });

            // [입장 메시지 발송]
            sendSocketMessage("ENTER", nickname + "님이 입장하셨습니다.");
        });
    }

    // 4. 메시지 전송 (TALK 타입)
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value;
        if (content && stompClient) {
            sendSocketMessage("TALK", content);
            input.value = '';
        }
    }

    // 공통 소켓 전송 로직 (ChatMessageDTO 구조와 일치)
    function sendSocketMessage(type, content) {
        const chatMessage = {
            broadcastId: currentBroadcastId,
            memberId: 999, // 테스트용 ID
            type: type,
            sender: nickname,
            content: content,
            vodPlayTime: 0
        };
        stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
    }

    // 5. 메시지 화면 출력
    function showChatMessage(message) {
        const messageArea = document.getElementById('messageArea');
        const messageElement = document.createElement('div');

        // 메시지 타입에 따른 스타일 적용
        if (message.type === 'ENTER' || message.type === 'EXIT') {
            messageElement.classList.add('message', 'system-msg');
            messageElement.innerText = message.content;
        } else {
            messageElement.classList.add('message');
            // 내가 보낸 메시지인지 확인
            if (message.sender === nickname) {
                messageElement.classList.add('my-msg');
                messageElement.innerText = message.content;
            } else {
                messageElement.classList.add('other-msg');
                messageElement.innerText = `${message.sender}: ${message.content}`;
            }
        }

        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight; // 최하단 스크롤
    }

    // 6. 방 나가기
    function leaveRoom() {
        if (stompClient) {
            sendSocketMessage("EXIT", nickname + "님이 퇴장하셨습니다.");
            stompClient.disconnect();
        }
        document.getElementById('chatRoom').style.display = 'none';
        document.getElementById('lobby').style.display = 'block';
        fetchRooms();
    }
</script>

</body>
</html>